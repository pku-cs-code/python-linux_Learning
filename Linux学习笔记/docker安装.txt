



centos7安装docker时需要配置repository，
[root@localhost ~]# yum-config-manager     --add-repo     https://download.docker.com/linux/centos/docker-ce.repo
Loaded plugins: fastestmirror
adding repo from: https://download.docker.com/linux/centos/docker-ce.repo
grabbing file https://download.docker.com/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo
Could not fetch/save url https://download.docker.com/linux/centos/docker-ce.repo to file /etc/yum.repos.d/docker-ce.repo: [Errno 12] Timeout on https://download.docker.com/linux/centos/docker-ce.repo: (28, 'Operation too slow. Less than 1000 bytes/sec transferred the last 30 seconds')

原因是电脑上的shadowsocks代理使得虚拟机超时




Error: Package: docker-ce-17.03.0.ce-1.el7.centos.x86_64 (/docker-ce-17.03.0.ce-1.el7.centos.x86_64)
           Requires: docker-ce-selinux >= 17.03.0.ce-1.el7.centos
           Available: docker-ce-selinux-17.03.0.ce-1.el7.centos.noarch (docker-ce-stable)
               docker-ce-selinux = 17.03.0.ce-1.el7.centos
           Available: docker-ce-selinux-17.03.1.ce-1.el7.centos.noarch (docker-ce-stable)
               docker-ce-selinux = 17.03.1.ce-1.el7.centos
           Available: docker-ce-selinux-17.03.2.ce-1.el7.centos.noarch (docker-ce-stable)
               docker-ce-selinux = 17.03.2.ce-1.el7.centos


安装包下载目录地址
https://download.docker.com/linux/centos/7/x86_64/stable/Packages/

去下载相应的依赖docker-ce-selinux的17.03.0版本,下载这两个文件后去这个文件所在的目录执行
  615  yum install docker-ce-selinux-17.03.0.ce-1.el7.centos.noarch.rpm 
  616  yum install docker-ce-17.03.0.ce-1.el7.centos.x86_64.rpm 

https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-selinux-17.03.0.ce-1.el7.centos.noarch.rpm



第一次没有下载好gitlab-runner镜像，docker会自己拉，下好后再次执行同样的命令就好。


[root@localhost ~]# docker run -d --name gitlab-runner --restart always \
   -v /var/run/docker.sock:/var/run/docker.sock \
   -v /srv/gitlab-runner/config:/etc/gitlab-runner \
   gitlab/gitlab-runner:latest
docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.
See 'docker run --help'.

docker没有启动
启动docker
 systemctl start docker
 
 注册docker的git-runner
 这里的url和token去gitlab页面admin/runners里面去找到就好
 一些后面的设置不是特别清楚。然后注册成功后在gitlab里面就能看到注册好的runner了
 
 
 
 
 [root@localhost ~]# docker exec -it gitlab-runner gitlab-runner register
Running in system-mode.                            
                                                   
Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):
http://10.10.1.113/
Please enter the gitlab-ci token for this runner:
xSk6fMZyNSmLDk1_ppQs
Please enter the gitlab-ci description for this runner:
[03c89f481c96]: gitlabdockertest   
Please enter the gitlab-ci tags for this runner (comma separated):
dockertest   
Whether to run untagged builds [true/false]:
[false]: true
Whether to lock the Runner to current project [true/false]:
[true]: true
Registering runner... succeeded                     runner=xSk6fMZy
Please enter the executor: docker, shell, ssh, docker-ssh+machine, docker-ssh, parallels, virtualbox, docker+machine, kubernetes:
docker
Please enter the default Docker image (e.g. ruby:2.1):
alpine:latest
Runner registered successfully. Feel free to start it, but if it's running already the config should be automatically reloaded! 


docker安装gitlab-runner参考文档
http://docs.gitlab.com/runner/install/docker.html


gitlab错误

Whoops, GitLab is taking too much time to respond.

原因是根分区磁盘太小。删除了mysql多了400多M就够了

要把unicorn里监听的8080端口改成别的，避免和httpd大灯舞端口重叠

启动docker，下载golang对应的image

也可能是我的虚拟机资源不够用了

systemctl start docker
[root@localhost ~]# docker run golang:1.5



进入docker某个特定container的目录中
[root@localhost run]# docker exec -it gitlab-runner /bin/bash





gitlab-runner重名
[root@localhost ~]# docker run -d --name gitlab-runner --restart always \
   -v /srv/gitlab-runner/config:/etc/gitlab-runner \
   -v /var/run/docker.sock:/var/run/docker.sock \
   gitlab/gitlab-runner:latest
docker: Error response from daemon: Conflict. The container name "/gitlab-runner" is already in use by container 03c89f481c96bb5e436a326028d30138ab594821675777733811b020758bf318. You have to remove (or rename) that container to be able to reuse that name..
See 'docker run --help'.
[root@localhost ~]# docker run /gitlab-runner
docker: Error parsing reference: "/gitlab-runner" is not a valid repository/tag: invalid reference format.
See 'docker run --help'.
[root@localhost ~]# 

网络上不了外网，我的vps ping值出奇的高，平常一般在100ms左右
国内的网站百度都可以上
连哈佛、mit的网站都打不开了
手机4G可以打开


[root@test ~]# ping 138.128.206.105
PING 138.128.206.105 (138.128.206.105) 56(84) bytes of data.
64 bytes from 138.128.206.105: icmp_seq=11 ttl=48 time=547 ms
64 bytes from 138.128.206.105: icmp_seq=15 ttl=48 time=494 ms
64 bytes from 138.128.206.105: icmp_seq=18 ttl=48 time=544 ms
64 bytes from 138.128.206.105: icmp_seq=41 ttl=48 time=493 ms
64 bytes from 138.128.206.105: icmp_seq=43 ttl=48 time=656 ms
64 bytes from 138.128.206.105: icmp_seq=44 ttl=48 time=481 ms

[root@test ~]# ping www.baidu.com
PING www.a.shifen.com (61.135.169.125) 56(84) bytes of data.
64 bytes from 61.135.169.125: icmp_seq=1 ttl=49 time=3.61 ms
64 bytes from 61.135.169.125: icmp_seq=2 ttl=49 time=4.10 ms
64 bytes from 61.135.169.125: icmp_seq=3 ttl=49 time=4.24 ms
64 bytes from 61.135.169.125: icmp_seq=4 ttl=49 time=28.9 ms
64 bytes from 61.135.169.125: icmp_seq=5 ttl=49 time=3.85 ms
64 bytes from 61.135.169.125: icmp_seq=6 ttl=49 time=39.9 ms
64 bytes from 61.135.169.125: icmp_seq=7 ttl=49 time=3.84 ms
64 bytes from 61.135.169.125: icmp_seq=8 ttl=49 time=4.02 ms
64 bytes from 61.135.169.125: icmp_seq=9 ttl=49 time=3.86 ms



docker run -i -t


这个可以执行
 docker run gitlab/gitlab-runner:latest
 
 
 
 
 gitlab上的runner显示端显示
 fatal: unable to access 'http://gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@gitlab.example.com/root/test.git/': Couldn't resolve host 'gitlab.example.com'
 
 
 
 去runner所在机器去curl这个网址
 
 [root@localhost ~]# curl -verbose http://gitlab-ci-token:xxxxxxxxxxxxxxxxxxxx@gitlab.example.com/root/test.git/
* About to connect() to gitlab.example.com port 80 (#0)
*   Trying 10.10.1.113...
* Connected to gitlab.example.com (10.10.1.113) port 80 (#0)
* Server auth using Basic with user 'gitlab-ci-token'
> GET /root/test.git/ HTTP/1.1
> Authorization: Basic Z2l0bGFiLWNpLXRva2VuOnh4eHh4eHh4eHh4eHh4eHh4eHh4
> User-Agent: curl/7.29.0
> Host: gitlab.example.com
> Accept: */*
> Referer: rbose
> 
< HTTP/1.1 302 Found
< Server: nginx
< Date: Wed, 18 Oct 2017 02:01:44 GMT
< Content-Type: text/html; charset=utf-8
< Content-Length: 101
< Connection: keep-alive
< Cache-Control: no-cache
< Location: http://gitlab.example.com/root/test
< X-Content-Type-Options: nosniff
< X-Frame-Options: DENY
< X-Request-Id: eaabe898-e30b-45a8-81b2-1f7d65787424
< X-Runtime: 0.046874
< X-Ua-Compatible: IE=edge
< X-Xss-Protection: 1; mode=block
< Strict-Transport-Security: max-age=31536000
< 
* Connection #0 to host gitlab.example.com left intact
<html><body>You are being <a href="http://gitlab.example.com/root/test">redirected</a>.</body></html>[root@localhost ~]# 


docker ps -a
列出dockerimage的执行情况
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                    PORTS               NAMES
3791b2a24318        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   16 hours ago        Exited (0) 16 hours ago                       optimistic_cori
9636715b2b1b        hello-world                   "/hello"                 16 hours ago        Exited (0) 16 hours ago                       hopeful_swanson
e7dea553176c        golang:1.5                    "/bin/bash"              16 hours ago        Exited (0) 16 hours ago                       kind_hawking
9fb55f5c18ef        hello-world                   "/hello"                 16 hours ago        Exited (0) 16 hours ago                       gallant_lichterman
b2610b3ee934        golang:1.5                    "/bin/bash"              6 days ago          Exited (0) 6 days ago                         determined_banach
2cb49e6f710f        e5e66321e8ec                  "gitlab-runner-cac..."   6 days ago          Exited (0) 6 days ago                         runner-986e2214-project-4-concurrent-0-cache-3c3f060a0374fc8bc39395164f415a70
076ebf612c73        e5e66321e8ec                  "gitlab-runner-cac..."   6 days ago          Exited (0) 6 days ago                         runner-986e2214-project-4-concurrent-0-cache-28934d7b9a9154212a5dd671e4fa5704
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   7 days ago          Up 10 minutes                                 gitlab-runner
25e219c94557        hello-world                   "/hello"                 8 days ago          Exited (0) 8 days ago                         elastic_beaver
3d0a40d53c20        hello-world                   "/hello"                 8 days ago          Exited (0) 8 days ago  



gitlab-runner 的log路径/var/log/gitlab/gitlab-rails/production.log

gitlab服务端路径
/var/opt/gitlab/gitlab-workhorse

check the gitlab-workhorse version

[root@test gitlab-workhorse]# /opt/gitlab/embedded/bin/gitlab-workhorse -version
gitlab-workhorse v3.0.0-20171005.085530


打开gitlab的默认配置文件
1
$    sudo vim /etc/gitlab/gitlab.rb
将external_url的值设置为以下文本(这里填入自己的域名):
1
external_url 'https://git.adair.com'

配置gitlab参考文档

http://adairjun.github.io/2016/12/20/gitlab/


docker run -d --name gitlab-runner --restart always \
   -v /srv/gitlab-runner/config:/etc/gitlab-runner \
   -v /var/run/docker.sock:/var/run/docker.sock \
   gitlab/gitlab-runner:latest
   
   
   
root@03c89f481c96:/# gitlab-ci-multi-runner verify
Running in system-mode.                            
                                                   
Verifying runner... is alive                        runner=986e2214


查看注册的gitlab-runner

root@03c89f481c96:/# gitlab-runner list
Listing configured runners                          ConfigFile=/etc/gitlab-runner/config.toml
gitlabdockertest                                    Executor=docker Token=986e221487dd96e18f01e824acbbe1 URL=http://10.10.1.113/


查看已安装的images
[root@localhost ~]# docker images
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
gitlab/gitlab-runner-helper   x86_64-a9a76a50     e5e66321e8ec        8 days ago          43.1 MB
gitlab/gitlab-runner          latest              fa332bc1925c        2 weeks ago         371 MB
hello-world                   latest              05a3bd381fc2        5 weeks ago         1.84 kB
golang                        1.5                 99668503de15        14 months ago       725 MB


centos7设置docker开机启动
systemctl enable docker


检查系统兼容性
curl https://raw.githubusercontent.com/docker/docker/master/contrib/check-config.sh > check-config.sh

$ bash ./check-config.sh



From a terminal on your Docker host, run the following docker run commands. The strings at the end are the IDs of each container.

$ docker run -dit --name my_container_1 acme/my-final-image:1.0 bash \
  && docker run -dit --name my_container_2 acme/my-final-image:1.0 bash \
  && docker run -dit --name my_container_3 acme/my-final-image:1.0 bash \
  && docker run -dit --name my_container_4 acme/my-final-image:1.0 bash \
  && docker run -dit --name my_container_5 acme/my-final-image:1.0 bash

  c36785c423ec7e0422b2af7364a7ba4da6146cbba7981a0951fcc3fa0430c409
  dcad7101795e4206e637d9358a818e5c32e13b349e62b00bf05cd5a4343ea513
  1e7264576d78a3134fbaf7829bc24b1d96017cf2bc046b7cd8b08b5775c33d0c
  38fa94212a419a082e6a6b87a8e2ec4a44dd327d7069b85892a707e3fc818544
  1a174fc216cccf18ec7d4fe14e008e30130b11ede0f0f94a87982e310cf2e765
  
  
build an app image
  
  https://docs.docker.com/get-started/part2/#build-the-app
  
docker build -t friendlyhello .



Run the app, mapping your machine’s port 4000 to the container’s published port 80 using -p:

docker run -p 4000:80 friendlyhello


docker进入container
参考文档：
https://github.com/ma6174/blog/issues/8


docker attach ${container-id}

[root@localhost ~]# docker run -it friendlyhello bash
root@b47c1968a630:/app# 
进入之后发现工作目录果然在/app下




列出容器
[root@localhost ~]# docker container  ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
b47c1968a630        friendlyhello                 "bash"                   2 minutes ago       Up 2 minutes        80/tcp              goofy_kalam
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   10 days ago         Up 5 hours                              gitlab-runner


注意friendlyhello这对应的容器销毁之后docker container ls的变化
[root@localhost ~]# docker container  ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
b47c1968a630        friendlyhello                 "bash"                   3 minutes ago       Up 3 minutes        80/tcp              goofy_kalam
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   10 days ago         Up 5 hours                              gitlab-runner
[root@localhost ~]# docker container  ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   10 days ago         Up 5 hours                              gitlab-runner



http://10.10.1.115:4000/下这里的hostname对应的是container-id


Hello World!

Hostname: 664607dd82a2
Visits: cannot connect to Redis, counter disabled


手动停止container之后的变化
[root@localhost ~]# docker container  ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED              STATUS              PORTS                  NAMES
664607dd82a2        friendlyhello                 "python app.py"          About a minute ago   Up About a minute   0.0.0.0:4000->80/tcp   wizardly_darwin
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   10 days ago          Up 5 hours                                 gitlab-runner
[root@localhost ~]# docker container  stop 664607dd82a2
664607dd82a2
[root@localhost ~]# docker container  ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   10 days ago         Up 5 hours                              gitlab-runner


[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
[root@localhost ~]# docker login
Login with your Docker ID to push and pull images from Docker Hub. If you don't have a Docker ID, head over to https://hub.docker.com to create one.
Username: caizhang    
Password: 
Login Succeeded
[root@localhost ~]# docker ps -a
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS                     PORTS               NAMES
664607dd82a2        friendlyhello                 "python app.py"          2 days ago          Exited (137) 2 days ago                        wizardly_darwin
b47c1968a630        friendlyhello                 "bash"                   2 days ago          Exited (127) 2 days ago                        goofy_kalam
8f6f8c03646f        friendlyhello                 "python app.py"          2 days ago          Exited (0) 2 days ago                          focused_saha
3791b2a24318        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   5 days ago          Exited (0) 5 days ago                          optimistic_cori
9636715b2b1b        hello-world                   "/hello"                 5 days ago          Exited (0) 5 days ago                          hopeful_swanson
e7dea553176c        golang:1.5                    "/bin/bash"              5 days ago          Exited (0) 5 days ago                          kind_hawking
9fb55f5c18ef        hello-world                   "/hello"                 5 days ago          Exited (0) 5 days ago                          gallant_lichterman
b2610b3ee934        golang:1.5                    "/bin/bash"              11 days ago         Exited (0) 11 days ago                         determined_banach
2cb49e6f710f        e5e66321e8ec                  "gitlab-runner-cac..."   12 days ago         Exited (0) 12 days ago                         runner-986e2214-project-4-concurrent-0-cache-3c3f060a0374fc8bc39395164f415a70
076ebf612c73        e5e66321e8ec                  "gitlab-runner-cac..."   12 days ago         Exited (0) 12 days ago                         runner-986e2214-project-4-concurrent-0-cache-28934d7b9a9154212a5dd671e4fa5704
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   12 days ago         Exited (0) 9 minutes ago                       gitlab-runner
25e219c94557        hello-world                   "/hello"                 13 days ago         Exited (0) 13 days ago                         elastic_beaver
3d0a40d53c20        hello-world                   "/hello"                 13 days ago         Exited (0) 13 days ago                         agitated_roentgen
[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
[root@localhost ~]# docker start gitlab
Error response from daemon: No such container: gitlab
Error: failed to start containers: gitlab
[root@localhost ~]# docker start gitlab/gitlab-runner:latest
Error response from daemon: No such container: gitlab/gitlab-runner:latest
Error: failed to start containers: gitlab/gitlab-runner:latest
[root@localhost ~]# docker tag friendlyhello john/getstarted:part2
[root@localhost ~]# docker images
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
friendlyhello                 latest              8519ea07ed26        2 days ago          195 MB
john/getstarted               part2               8519ea07ed26        2 days ago          195 MB
gitlab/gitlab-runner-helper   x86_64-a9a76a50     e5e66321e8ec        12 days ago         43.1 MB
ubuntu                        latest              747cb2d60bbe        12 days ago         122 MB
python                        2.7-slim            9724e90f1f17        13 days ago         184 MB
gitlab/gitlab-runner          latest              fa332bc1925c        2 weeks ago         371 MB
hello-world                   latest              05a3bd381fc2        5 weeks ago         1.84 kB
golang                        1.5                 99668503de15        15 months ago       725 MB


[root@localhost ~]# docker images 
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
friendlyhello                 latest              8519ea07ed26        2 days ago          195 MB
john/getstarted               part2               8519ea07ed26        2 days ago          195 MB
gitlab/gitlab-runner-helper   x86_64-a9a76a50     e5e66321e8ec        12 days ago         43.1 MB
ubuntu                        latest              747cb2d60bbe        12 days ago         122 MB
python                        2.7-slim            9724e90f1f17        13 days ago         184 MB
gitlab/gitlab-runner          latest              fa332bc1925c        2 weeks ago         371 MB
hello-world                   latest              05a3bd381fc2        5 weeks ago         1.84 kB
golang                        1.5                 99668503de15        15 months ago       725 MB
[root@localhost ~]# docker images ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE



root@localhost ~]# docker push friendlyhello:latest
The push refers to a repository [docker.io/library/friendlyhello]
655f9c5e1c92: Preparing 
c4c860bef193: Preparing 
a9a4470f37bd: Preparing 
f39f8a7b1485: Preparing 
5e4d4a29edae: Preparing 
f46f014db30a: Waiting 
c01c63c6823d: Waiting 
denied: requested access to the resource is denied
[root@localhost ~]# docker tag friendlyhello caizhang/testimage:version0.1
[root@localhost ~]# docker push caizhang/testimage:version0.1

没有指定tag则默认的tag是latest

[root@localhost ~]# docker image ls
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
caizhang/testimage            version0.1          8519ea07ed26        2 days ago          195 MB
caizhang/testtag              latest              8519ea07ed26        2 days ago          195 MB
friendlyhello                 latest              8519ea07ed26        2 days ago          195 MB
john/getstarted               part2               8519ea07ed26        2 days ago          195 MB
gitlab/gitlab-runner-helper   x86_64-a9a76a50     e5e66321e8ec        12 days ago         43.1 MB
ubuntu                        latest              747cb2d60bbe        12 days ago         122 MB
python                        2.7-slim            9724e90f1f17        13 days ago         184 MB
gitlab/gitlab-runner          latest              fa332bc1925c        2 weeks ago         371 MB
hello-world                   latest              05a3bd381fc2        5 weeks ago         1.84 kB
golang                        1.5                 99668503de15        15 months ago       725 MB


再次不指定tag会覆盖之前的latest版本的image


Note: If you don’t specify the :tag portion of these commands, the tag of :latest will be assumed, both when you build and when you run images. Docker will use the last version of the image that ran without a tag specified (not necessarily the most recent image).


重启docker
[root@localhost ~]# systemctl restart docker
[root@localhost ~]# docker ps -q
03c89f481c96
[root@localhost ~]# docker ps -a
CONTAINER ID        IMAGE                         COMMAND                  CREATED              STATUS                        PORTS               NAMES
7b2132603ee0        gitlab/gitlab-runner          "/usr/bin/dumb-ini..."   About a minute ago   Exited (0) 28 seconds ago                         goofy_euclid
72b039e4db83        friendlyhello                 "python app.py"          3 minutes ago        Exited (137) 18 seconds ago                       vibrant_swirles
664607dd82a2        friendlyhello                 "python app.py"          2 days ago           Exited (137) 2 days ago                           wizardly_darwin
b47c1968a630        friendlyhello                 "bash"                   2 days ago           Exited (127) 2 days ago                           goofy_kalam
8f6f8c03646f        friendlyhello                 "python app.py"          2 days ago           Exited (0) 2 days ago                             focused_saha
3791b2a24318        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   5 days ago           Exited (0) 5 days ago                             optimistic_cori
9636715b2b1b        hello-world                   "/hello"                 5 days ago           Exited (0) 5 days ago                             hopeful_swanson
e7dea553176c        golang:1.5                    "/bin/bash"              5 days ago           Exited (0) 5 days ago                             kind_hawking
9fb55f5c18ef        hello-world                   "/hello"                 5 days ago           Exited (0) 5 days ago                             gallant_lichterman
b2610b3ee934        golang:1.5                    "/bin/bash"              12 days ago          Exited (0) 12 days ago                            determined_banach
2cb49e6f710f        e5e66321e8ec                  "gitlab-runner-cac..."   12 days ago          Exited (0) 12 days ago                            runner-986e2214-project-4-concurrent-0-cache-3c3f060a0374fc8bc39395164f415a70
076ebf612c73        e5e66321e8ec                  "gitlab-runner-cac..."   12 days ago          Exited (0) 12 days ago                            runner-986e2214-project-4-concurrent-0-cache-28934d7b9a9154212a5dd671e4fa5704
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   13 days ago          Up 14 seconds                                     gitlab-runner
25e219c94557        hello-world                   "/hello"                 13 days ago          Exited (0) 13 days ago                            elastic_beaver
3d0a40d53c20        hello-world                   "/hello"                 13 days ago          Exited (0) 13 days ago                            agitated_roentgen
[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   13 days ago         Up 20 seconds                           gitlab-runner



再启动一个friendlyhello
[root@localhost ~]#  docker run -p 4000:80 friendlyhello
docker: Error response from daemon: driver failed programming external connectivity on endpoint dazzling_hypatia (15dcd7d3325fa469e30ebe18292706c27e27d1066852c255dec262d1366e4e19): Bind for 0.0.0.0:4000 failed: port is already allocated.
[root@localhost ~]#  docker run -p 4000:8080 friendlyhello
docker: Error response from daemon: driver failed programming external connectivity on endpoint peaceful_cray (29ccd13500905e5b55abcba382e8ba6d2c34b99f7699c95311ec7282be0432bd): Bind for 0.0.0.0:4000 failed: port is already allocated.
[root@localhost ~]#  docker run -p 4001:8080 friendlyhello
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
 
会生成一个新的container
[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                            NAMES
8b2812c1b79d        friendlyhello                 "python app.py"          16 seconds ago      Up 15 seconds       80/tcp, 0.0.0.0:4001->8080/tcp   jovial_blackwell
66b365dfc46b        friendlyhello                 "python app.py"          49 seconds ago      Up 48 seconds       0.0.0.0:4000->80/tcp             elegant_jang
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   13 days ago         Up 6 minutes                                         gitlab-runner

再启动一个也可以。只要对应宿主机的port不重复就可以。但是不同container的port可以重复，因为他们是处于分隔的container中，彼此互不影响
[root@localhost ~]# docker run -p 4002:80 friendlyhello
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit) 
 
[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED              STATUS              PORTS                            NAMES
f5d57a897836        friendlyhello                 "python app.py"          About a minute ago   Up About a minute   0.0.0.0:4002->80/tcp             compassionate_wright
8b2812c1b79d        friendlyhello                 "python app.py"          4 minutes ago        Up 4 minutes        80/tcp, 0.0.0.0:4001->8080/tcp   jovial_blackwell
66b365dfc46b        friendlyhello                 "python app.py"          4 minutes ago        Up 4 minutes        0.0.0.0:4000->80/tcp             elegant_jang
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   13 days ago          Up 11 minutes                                        gitlab-runner




docker push到docker hub成功

[root@localhost ~]# docker  push caizhang/testtag
The push refers to a repository [docker.io/caizhang/testtag]
655f9c5e1c92: Preparing 
c4c860bef193: Preparing 
655f9c5e1c92: Mounted from caizhang/testimage 
c4c860bef193: Mounted from caizhang/testimage 
a9a4470f37bd: Mounted from caizhang/testimage 
f39f8a7b1485: Mounted from caizhang/testimage 
5e4d4a29edae: Mounted from caizhang/testimage 



f46f014db30a: Mounted from caizhang/testimage 
c01c63c6823d: Pushed 
latest: digest: sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636 size: 1787
655f9c5e1c92: Layer already exists 
c4c860bef193: Layer already exists 
a9a4470f37bd: Layer already exists 
f39f8a7b1485: Layer already exists 
5e4d4a29edae: Layer already exists 
f46f014db30a: Layer already exists 
c01c63c6823d: Layer already exists 
v0.1: digest: sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636 size: 1787
 
 
 
 
docker-compose.yml配置文件


 
version: "3"
services:
  web:
    # replace username/repo:tag with your name and image details
    image: caizhang/testtag:v0.1 
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
         restart_policy:
        condition: on-failure
    ports:
      - "80:80"
    networks:
      - webnet
networks:
  webnet:
  
  
  
  
  [root@localhost home]# docker stack deploy -c docker-compose.yml  getstartedlab
This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.
[root@localhost home]# docker swarm init
Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (10.10.1.115 on ens33 and 10.10.1.228 on ens37) - specify one with --advertise-addr


[root@localhost home]# ifdown ens37
usage: ifdown <configuration>

root@localhost network-scripts]# ifconfig
docker0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 172.17.0.1  netmask 255.255.0.0  broadcast 0.0.0.0
        inet6 fe80::42:39ff:fea4:d5e6  prefixlen 64  scopeid 0x20<link>
        ether 02:42:39:a4:d5:e6  txqueuelen 0  (Ethernet)
        RX packets 6648  bytes 383960 (374.9 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 6646  bytes 649584 (634.3 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens33: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.10.1.115  netmask 255.255.255.0  broadcast 10.10.1.255
        inet6 fe80::a4d2:5e6c:a935:ea3a  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:d8:82:0a  txqueuelen 1000  (Ethernet)
        RX packets 32445  bytes 2383843 (2.2 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 1503  bytes 91161 (89.0 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

ens37: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.10.1.228  netmask 255.255.255.0  broadcast 10.10.1.255
        inet6 fe80::2979:825f:172c:78bf  prefixlen 64  scopeid 0x20<link>
        ether 00:0c:29:d8:82:14  txqueuelen 1000  (Ethernet)
        RX packets 30166  bytes 2271301 (2.1 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 5500  bytes 423945 (414.0 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1  (Local Loopback)
        RX packets 4  bytes 336 (336.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 4  bytes 336 (336.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

vethd343873: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet6 fe80::9c9f:11ff:fe07:a93c  prefixlen 64  scopeid 0x20<link>
        ether 9e:9f:11:07:a9:3c  txqueuelen 0  (Ethernet)
        RX packets 6648  bytes 477032 (465.8 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 6654  bytes 650232 (634.9 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
		
		
		

因为这台机器上没有ifcfg-ens37配置文件，但是dhcp给网口自动分了ip，故导致无法通过ifdown命令关闭掉网卡


在网卡配置文件处新建ifcfg-ens37配置文件，注意删除掉从ens33拷贝过来的haddr、uuid、设备名等，将onboot选项改为no，然后systemctl restart network 重启网卡，ifconfig就看不到ens37这块设备了


[root@localhost network-scripts]# docker stack deploy -c /home/docker-compose.yml getstartedlab
This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.
[root@localhost network-scripts]# docker swarm init
Swarm initialized: current node (t8dkl1pnuzm260werpdrg31sx) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-4hrvxgrzgz15e5d5iosay8u5ziu7ryes2gymofvu82yj3ceokw-b1w3z3wsetigqz6k4danfxn5n \
    10.10.1.115:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

[root@localhost network-scripts]# docker stack deploy -c /home/docker-compose.yml getstartedlab
Creating network getstartedlab_webnet
Creating service getstartedlab_web
[root@localhost network-scripts]# docker service ls
ID            NAME               MODE        REPLICAS  IMAGE
vrqdtom06d9n  getstartedlab_web  replicated  5/5       caizhang/testtag:v0.1

[root@localhost network-scripts]# docker service ps getstartedlab
Error: No such service: getstartedlab
[root@localhost network-scripts]# docker service ps getstartedlab_web
ID            NAME                 IMAGE                  NODE                   DESIRED STATE  CURRENT STATE          ERROR  PORTS
vk9c0xgzfivm  getstartedlab_web.1  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 8 minutes ago         
u2zhuphfbrhz  getstartedlab_web.2  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 8 minutes ago         
glqfmakgkxrq  getstartedlab_web.3  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 8 minutes ago         
ny5r3jwfo737  getstartedlab_web.4  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 8 minutes ago         
ee64opoxdfay  getstartedlab_web.5  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 8 minutes ago 



[root@localhost network-scripts]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
7329a75117e6        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.2.u2zhuphfbrhz2gisifydfiujv
9bcfa487942b        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.3.glqfmakgkxrqov4g9m7rmxr9p
ed5797ebe541        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.4.ny5r3jwfo737va2n7qehiq962
f60312a8e2ff        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.5.ee64opoxdfayt1360vn685mhr
9d5097d836e9        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.1.vk9c0xgzfivm2bx6vc5w5v487
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago         Up 2 hours                              gitlab-runner
[root@localhost network-scripts]# docker inspect --format="{{index .Config.Labels \"com.docker.swarm.task.id\"}}" <container>
-bash: syntax error near unexpected token `newline'
[root@localhost network-scripts]# docker inspect --format="{{index .Config.Labels \"com.docker.swarm.task.id\"}}"  
"docker inspect" requires at least 1 argument(s).
See 'docker inspect --help'.

Usage:  docker inspect [OPTIONS] NAME|ID [NAME|ID...]

Return low-level information on Docker objects
[root@localhost network-scripts]# docker inspect --format='{{.Status.ContainerStatus.ContainerID}}' getstartedlab_web

Template parsing error: template: :1:9: executing "" at <.Status.ContainerSta...>: map has no entry for key "Status"
[root@localhost network-scripts]# docker inspect 7329a75117e6
[
    {
        "Id": "7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063",
        "Created": "2017-10-24T15:20:27.102161126Z",
        "Path": "python",
        "Args": [
            "app.py"
        ],
        "State": {
            "Status": "running",
            "Running": true,
            "Paused": false,
            "Restarting": false,
            "OOMKilled": false,
            "Dead": false,
            "Pid": 3740,
            "ExitCode": 0,
            "Error": "",
            "StartedAt": "2017-10-24T15:20:32.640264453Z",
            "FinishedAt": "0001-01-01T00:00:00Z"
        },
        "Image": "sha256:8519ea07ed26126f77baa47196fa3b2618a9f7b0bf5ec262c40b2c0e1fc7c45e",
        "ResolvConfPath": "/var/lib/docker/containers/7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063/resolv.conf",
        "HostnamePath": "/var/lib/docker/containers/7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063/hostname",
        "HostsPath": "/var/lib/docker/containers/7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063/hosts",
        "LogPath": "/var/lib/docker/containers/7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063/7329a75117e693612ba4c4b5d37b2a4c8d79e8eea6784559c5027e8817bf1063-json.log",
        "Name": "/getstartedlab_web.2.u2zhuphfbrhz2gisifydfiujv",
        "RestartCount": 0,
        "Driver": "overlay",
        "MountLabel": "",
        "ProcessLabel": "",
        "AppArmorProfile": "",
        "ExecIDs": null,
        "HostConfig": {
            "Binds": null,
            "ContainerIDFile": "",
            "LogConfig": {
                "Type": "json-file",
                "Config": {}
            },
            "NetworkMode": "default",
            "PortBindings": {},
            "RestartPolicy": {
                "Name": "",
                "MaximumRetryCount": 0
            },
            "AutoRemove": false,
            "VolumeDriver": "",
            "VolumesFrom": null,
            "CapAdd": null,
            "CapDrop": null,
            "Dns": null,
            "DnsOptions": null,
            "DnsSearch": null,
            "ExtraHosts": null,
            "GroupAdd": null,
            "IpcMode": "",
            "Cgroup": "",
            "Links": null,
            "OomScoreAdj": 0,
            "PidMode": "",
            "Privileged": false,
            "PublishAllPorts": false,
            "ReadonlyRootfs": false,
            "SecurityOpt": null,
            "UTSMode": "",
            "UsernsMode": "",
            "ShmSize": 67108864,
            "Runtime": "runc",
            "ConsoleSize": [
                0,
                0
            ],
            "Isolation": "",
            "CpuShares": 0,
            "Memory": 52428800,
            "NanoCpus": 0,
            "CgroupParent": "",
            "BlkioWeight": 0,
            "BlkioWeightDevice": null,
            "BlkioDeviceReadBps": null,
            "BlkioDeviceWriteBps": null,
            "BlkioDeviceReadIOps": null,
            "BlkioDeviceWriteIOps": null,
            "CpuPeriod": 100000,
            "CpuQuota": 10000,
            "CpuRealtimePeriod": 0,
            "CpuRealtimeRuntime": 0,
            "CpusetCpus": "",
            "CpusetMems": "",
            "Devices": null,
            "DiskQuota": 0,
            "KernelMemory": 0,
            "MemoryReservation": 0,
            "MemorySwap": 104857600,
            "MemorySwappiness": -1,
            "OomKillDisable": false,
            "PidsLimit": 0,
            "Ulimits": null,
            "CpuCount": 0,
            "CpuPercent": 0,
            "IOMaximumIOps": 0,
            "IOMaximumBandwidth": 0
        },
        "GraphDriver": {
            "Name": "overlay",
            "Data": {
                "LowerDir": "/var/lib/docker/overlay/b424cc5e926da9f239e3ba0caec19c34daf6f229c497455cb354576a34da7760/root",
                "MergedDir": "/var/lib/docker/overlay/e751105e4ddd35814741bbcba294fc1f8e48ccbcc96e5182ccbaaeeb9eefde9e/merged",
                "UpperDir": "/var/lib/docker/overlay/e751105e4ddd35814741bbcba294fc1f8e48ccbcc96e5182ccbaaeeb9eefde9e/upper",
                "WorkDir": "/var/lib/docker/overlay/e751105e4ddd35814741bbcba294fc1f8e48ccbcc96e5182ccbaaeeb9eefde9e/work"
            }
        },
        "Mounts": [],
        "Config": {
            "Hostname": "7329a75117e6",
            "Domainname": "",
            "User": "",
            "AttachStdin": false,
            "AttachStdout": false,
            "AttachStderr": false,
            "ExposedPorts": {
                "80/tcp": {}
            },
            "Tty": false,
            "OpenStdin": false,
            "StdinOnce": false,
            "Env": [
                "PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
                "LANG=C.UTF-8",
                "GPG_KEY=C01E1CAD5EA2C4F0B8E3571504C367C218ADD4FF",
                "PYTHON_VERSION=2.7.14",
                "PYTHON_PIP_VERSION=9.0.1",
                "NAME=World"
            ],
            "Cmd": [
                "python",
                "app.py"
            ],
            "ArgsEscaped": true,
            "Image": "caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636",
            "Volumes": null,
            "WorkingDir": "/app",
            "Entrypoint": null,
            "OnBuild": null,
            "Labels": {
                "com.docker.stack.namespace": "getstartedlab",
                "com.docker.swarm.node.id": "t8dkl1pnuzm260werpdrg31sx",
                "com.docker.swarm.service.id": "vrqdtom06d9nh58wylu9uugzp",
                "com.docker.swarm.service.name": "getstartedlab_web",
                "com.docker.swarm.task": "",
                "com.docker.swarm.task.id": "u2zhuphfbrhz2gisifydfiujv",
                "com.docker.swarm.task.name": "getstartedlab_web.2.u2zhuphfbrhz2gisifydfiujv"
            }
        },
        "NetworkSettings": {
            "Bridge": "",
            "SandboxID": "7740a491f54627123948bebe8435e4d42a886db2071dce67a1d91dfd1fbdbecd",
            "HairpinMode": false,
            "LinkLocalIPv6Address": "",
            "LinkLocalIPv6PrefixLen": 0,
            "Ports": {
                "80/tcp": null
            },
            "SandboxKey": "/var/run/docker/netns/7740a491f546",
            "SecondaryIPAddresses": null,
            "SecondaryIPv6Addresses": null,
            "EndpointID": "",
            "Gateway": "",
            "GlobalIPv6Address": "",
            "GlobalIPv6PrefixLen": 0,
            "IPAddress": "",
            "IPPrefixLen": 0,
            "IPv6Gateway": "",
            "MacAddress": "",
            "Networks": {
                "getstartedlab_webnet": {
                    "IPAMConfig": {
                        "IPv4Address": "10.0.0.3"
                    },
                    "Links": null,
                    "Aliases": [
                        "7329a75117e6"
                    ],
                    "NetworkID": "9e7eipj844ab2q7zjb3frof7y",
                    "EndpointID": "fceae5e4756eb2719b3f274a0dbe895f07f78048d179093f5fb2e4f006356e0b",
                    "Gateway": "",
                    "IPAddress": "10.0.0.3",
                    "IPPrefixLen": 24,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:0a:00:00:03"
                },
                "ingress": {
                    "IPAMConfig": {
                        "IPv4Address": "10.255.0.5"
                    },
                    "Links": null,
                    "Aliases": [
                        "7329a75117e6"
                    ],
                    "NetworkID": "siilb1cjrzajj9c8rmbgvwjzc",
                    "EndpointID": "907be511d3fcdee4c7300cbd0801674c688f782c7354406bc6eedf2a9c19871b",
                    "Gateway": "",
                    "IPAddress": "10.255.0.5",
                    "IPPrefixLen": 16,
                    "IPv6Gateway": "",
                    "GlobalIPv6Address": "",
                    "GlobalIPv6PrefixLen": 0,
                    "MacAddress": "02:42:0a:ff:00:05"
                }
            }
        }
    }
]
[root@localhost network-scripts]# 


docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' container_name_or_id


[root@localhost network-scripts]# docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' e372cd6d0b32
10.0.0.610.255.0.8
[root@localhost network-scripts]# 


应该是 '{{ .NetworkSettings.Networks.ingress.IPAddress }}'才对


[root@localhost network-scripts]# docker inspect -format '{{ .NetworkSettings.IPAddress }}' 75240efd7886

Error: No such object: {{ .NetworkSettings.IPAddress }}
[root@localhost network-scripts]# docker inspect --format '{{ .NetworkSettings.Networks.ingress.IPAddress }}' 75240efd7886
10.255.0.6

[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_web (id: vrqdtom06d9nh58wylu9uugzp)


[root@localhost ~]# docker run -p 4000:80 friendlyhello
WARNING: IPv4 forwarding is disabled. Networking will not work.
 * Running on http://0.0.0.0:80/ (Press CTRL+C to quit)
 
 
 解决办法
 https://stackoverflow.com/questions/41453263/docker-networking-disabled-warning-ipv4-forwarding-is-disabled-networking-wil
 
 在/etc/sysctl.conf:
 中添加一行，然后重启网卡
 #add a line net.ipv4.ip_forward=1 to make the container could communicate with outside world.
net.ipv4.ip_forward=1

 
 然后执行docker run -p 4000:80 friendlyhello可以在浏览器端输入http://10.10.1.115:4000访问。但是之前通过docker init配置的stack deploy输入的10.10.1.115:8080没有效果。
 
 搜了一些方法依然不管用。遂重启docker服务。systemctl restart docker
It works!!!可以看到集群swarm中不同container提供的页面。把service中的5个replicas一起集群提供服务。刷新这个网址可以看到不同的hostname，实际上就是对应的container_id

 
Hello World!
Hostname: a267ad951e47
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: e23bb625768c
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: a267ad951e47
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: b0123276906f
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: e23bb625768c
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: bd4ae9dfd61e
Visits: cannot connect to Redis, counter disabled

Hello World!
Hostname: 6abb95fe0157
Visits: cannot connect to Redis, counter disabled


[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
e23bb625768c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          11 minutes ago      Up 11 minutes       80/tcp              getstartedlab_web.4.lxup9l0y43vm147w1jwks6bjo
6abb95fe0157        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          11 minutes ago      Up 11 minutes       80/tcp              getstartedlab_web.2.qxm39vqrfvt5u2y4jvq8sul7o
a267ad951e47        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          11 minutes ago      Up 11 minutes       80/tcp              getstartedlab_web.1.mtom6b8a2akc2lfpca7dqyas2
b0123276906f        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          11 minutes ago      Up 11 minutes       80/tcp              getstartedlab_web.5.yf3xfkck82q723ss2fzw6ph8p
bd4ae9dfd61e        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          11 minutes ago      Up 11 minutes       80/tcp              getstartedlab_web.3.9jci0y29gvt4txagxl2ujtwe4
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago         Up 11 minutes                           gitlab-runner
[root@localhost ~]# docker container ls -q
e23bb625768c
6abb95fe0157
a267ad951e47
b0123276906f
bd4ae9dfd61e
03c89f481c96

更改配置文件改replicas为10后,
ocker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_web (id: vrqdtom06d9nh58wylu9uugzp)
[root@localhost home]# git container ls
git: 'container' is not a git command. See 'git --help'.
[root@localhost home]# docker  container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
4a501b03e033        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          16 seconds ago      Up 9 seconds        80/tcp              getstartedlab_web.9.r4rxcq91nbca0kmlirvrmglun
dd7be338bb40        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          16 seconds ago      Up 9 seconds        80/tcp              getstartedlab_web.8.m86ft0cbbjdm4ukz950vssmv1
900c9a8d1331        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          16 seconds ago      Up 9 seconds        80/tcp              getstartedlab_web.7.rlu587gw4fobhjngn0v1gckxo
5b0f377bcb35        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          16 seconds ago      Up 8 seconds        80/tcp              getstartedlab_web.6.69ka9t9fya2g9gj6sbdec44ck
bd69c4ad4386        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          16 seconds ago      Up 9 seconds        80/tcp              getstartedlab_web.10.geo0awxdnmfiziko6gs9r3em6
e23bb625768c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          17 minutes ago      Up 17 minutes       80/tcp              getstartedlab_web.4.lxup9l0y43vm147w1jwks6bjo
6abb95fe0157        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          17 minutes ago      Up 17 minutes       80/tcp              getstartedlab_web.2.qxm39vqrfvt5u2y4jvq8sul7o
a267ad951e47        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          17 minutes ago      Up 17 minutes       80/tcp              getstartedlab_web.1.mtom6b8a2akc2lfpca7dqyas2
b0123276906f        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          17 minutes ago      Up 17 minutes       80/tcp              getstartedlab_web.5.yf3xfkck82q723ss2fzw6ph8p
bd4ae9dfd61e        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          17 minutes ago      Up 17 minutes       80/tcp              getstartedlab_web.3.9jci0y29gvt4txagxl2ujtwe4
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago         Up 17 minutes      


有十个container了


更改docker-compose.yml中宿主机映射的端口为8081后，再次执行命令，只是这个stack名称换了一下就会创建一个新的stack


由于又创建了一个stack，虚拟机的内存只有512M，docker container ls或者docker service ls都会卡死。所以这给我们一个启示，集群的机器需要较大的资源。

[root@localhost home]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS                  PORTS               NAMES
f0b12c4a49ee        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          4 minutes ago       Up Less than a second   80/tcp              swarmtest_web.3.7muz4u0ya08z8bw46iqj58j8x
04ba2b0fd58f        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          4 minutes ago       Up About a minute       80/tcp              swarmtest_web.10.wpuqgessu7w6k3fzcq7p819sn
7893372b587d        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          4 minutes ago       Up About a minute       80/tcp              swarmtest_web.9.lefh26ejhhqj8em7ddzgdot3a
9b55c9f60223        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          4 minutes ago       Up 3 seconds            80/tcp              swarmtest_web.7.jaer4v5pnhpy40iv1rdg3fvx5
4a501b03e033        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          7 minutes ago       Up 6 minutes            80/tcp              getstartedlab_web.9.r4rxcq91nbca0kmlirvrmglun
dd7be338bb40        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          7 minutes ago       Up 6 minutes            80/tcp              getstartedlab_web.8.m86ft0cbbjdm4ukz950vssmv1
900c9a8d1331        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          7 minutes ago       Up 6 minutes            80/tcp              getstartedlab_web.7.rlu587gw4fobhjngn0v1gckxo
5b0f377bcb35        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          7 minutes ago       Up 6 minutes            80/tcp              getstartedlab_web.6.69ka9t9fya2g9gj6sbdec44ck
bd69c4ad4386        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          7 minutes ago       Up 6 minutes            80/tcp              getstartedlab_web.10.geo0awxdnmfiziko6gs9r3em6
e23bb625768c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          24 minutes ago      Up 24 minutes           80/tcp              getstartedlab_web.4.lxup9l0y43vm147w1jwks6bjo
6abb95fe0157        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          24 minutes ago      Up 24 minutes           80/tcp              getstartedlab_web.2.qxm39vqrfvt5u2y4jvq8sul7o
a267ad951e47        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          24 minutes ago      Up 24 minutes           80/tcp              getstartedlab_web.1.mtom6b8a2akc2lfpca7dqyas2
b0123276906f        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          24 minutes ago      Up 24 minutes           80/tcp              getstartedlab_web.5.yf3xfkck82q723ss2fzw6ph8p
bd4ae9dfd61e        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          24 minutes ago      Up 24 minutes           80/tcp              getstartedlab_web.3.9jci0y29gvt4txagxl2ujtwe4
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago         Up 24 minutes                               gitlab-runner


[root@localhost ~]# docker service ls
ID            NAME               MODE        REPLICAS  IMAGE
9jch5cti3hjg  swarmtest_web      replicated  0/10      caizhang/testtag:v0.1
vrqdtom06d9n  getstartedlab_web  replicated  10/10     caizhang/testtag:v0.1


[root@localhost home]# docker service ls
Error response from daemon: rpc error: code = 4 desc = context deadline exceeded

[root@localhost home]# docker service ls
Error response from daemon: rpc error: code = 4 desc = context deadline exceeded
 
 [root@localhost ~]# docker stack rm getstartedlab
Nothing found in stack: getstartedlab
[root@localhost ~]# docker stack rm swarmtest
Removing service swarmtest_web
Removing network swarmtest_webnet
[root@localhost ~]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
c2dfadf01961        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.10.mfqatvzzhzghmn8js16obncny
72a1ea0ab26f        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.3.tkwnlp54lr01tvv6b23dibsvm
9775d180c20e        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.8.l49x0bv3vsghcblyq75hqez0f
dc196f22a7a6        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.4.y756vtff1y9bsfuoswkwwqhh6
eefd564234ad        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.1.snu8j226fwqhgctprb2pozkg8
81cdd45c7e9c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.2.mnknnuuzgohe79g6u20j39eje
f4e62f6f3ebb        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.7.k95xgwx0lk0g8a8bx94adx85a
8aa1ca494efb        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.5.k5szqn42f3tyefc9l2zazpabc
e33607628e58        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.9.i919b42j6qaobpdj4olf36nkw
36854d643a0c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          2 minutes ago       Up About a minute   80/tcp              swarmtest_web.6.edlpr0rt5zrtotxrmrvlo4ysy
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago         Up 2 minutes                            gitlab-runner
[root@localhost ~]# docker service ls
ID  NAME  MODE  REPLICAS  IMAGE


[root@localhost ~]# docker swarm leave --force
Node left the swarm.
[root@localhost ~]# docker node ls
Error response from daemon: This node is not a swarm manager. Use "docker swarm init" or "docker swarm join" to connect this node to swarm and try again.



安装docker-machine是mac和windows针对docker之前版本集群才需要安装的。普通的linux直接就是安装的docker engine，为了集群，可以直接docker
swarm init配置warm node，然后根据提示来添加针对这个swarm node的worker或者manager。
[root@localhost ~]# docker swarm init
Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (10.10.1.115 on ens33 and 10.10.1.228 on ens37) - specify one with --advertise-addr
[root@localhost ~]# docker swarm init  --advertise-addr 10.10.1.115
Swarm initialized: current node (qe9smn202e5a9if1ug41sos1j) is now a manager.






To add a worker to this swarm, run the following command:

    docker swarm join \
    --token SWMTKN-1-5wnyu241jzu95bbtlq4h2nnuas5e7qow04iwzqoafkmu2z8p41-ek35b1gvvi294306678hwl172 \
    10.10.1.115:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

[root@localhost ~]# docker node ls
ID                           HOSTNAME               STATUS  AVAILABILITY  MANAGER STATUS
qe9smn202e5a9if1ug41sos1j *  localhost.localdomain  Ready   Active        Leader



install docker machine directly
ref:https://docs.docker.com/machine/install-machine/#install-machine-directly

curl -L https://github.com/docker/machine/releases/download/v0.13.0/docker-machine-`uname -s`-`uname -m` >/tmp/docker-machine &&
chmod +x /tmp/docker-machine &&
sudo cp /tmp/docker-machine /usr/local/bin/docker-machine

  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   617    0   617    0     0    283      0 --:--:--  0:00:02 --:--:--   283
100 25.3M  100 25.3M    0     0   156k      0  0:02:45  0:02:45 --:--:--  152k
[root@localhost ~]# docker-machine -v
docker-machine version 0.13.0, build 9ba6da9

 scripts=( docker-machine-prompt.bash docker-machine-wrapper.bash docker-machine.bash ); for i in "${scripts[@]}"; do sudo wget https://raw.githubusercontent.com/docker/machine/v0.13.0/contrib/completion/bash/${i} -P /etc/bash_completion.d; done
 vim ~/.bashrc 

 
加上 PS1='[\u@\h \W$(__docker_machine_ps1)]\$ '


先安装virtualbox虚拟机
[root@localhost ~]# docker-machine create --driver virtualbox myvm1
Running pre-create checks...
Error with pre-create check: "VBoxManage not found. Make sure VirtualBox is installed and VBoxManage is in the path"
[root@localhost ~]# yum install VirtualBox


[root@localhost yum.repos.d]# yum install VirtualBox
Loaded plugins: fastestmirror
Repository base is listed more than once in the configuration
Repository updates is listed more than once in the configuration
Repository extras is listed more than once in the configuration
virtualbox/7/x86_64/signature                                                                  |  181 B  00:00:00     
Retrieving key from https://www.virtualbox.org/download/oracle_vbox.asc
Importing GPG key 0x98AB5139:
 Userid     : "Oracle Corporation (VirtualBox archive signing key) <info@virtualbox.org>"
 Fingerprint: 7b0f ab3a 13b9 0743 5925 d9c9 5442 2a4b 98ab 5139
 From       : https://www.virtualbox.org/download/oracle_vbox.asc
Is this ok [y/N]: y
virtualbox/7/x86_64/signature                                                                  | 1.1 kB  00:00:05 !!! 
virtualbox/7/x86_64/primary                                                                    | 8.7 kB  00:00:01     
Loading mirror speeds from cached hostfile
 * base: centos.mirror.myduniahost.com
 * extras: centos.mirror.myduniahost.com
 * updates: mirror.qoxy.com
virtualbox                                                                                                      44/44
No package VirtualBox available.
Error: Nothing to do


去https://www.virtualbox.org/wiki/Linux_Downloads找到Oracle Linux 对应的Redhat发行版
centos7，下载相关的rpm文件，然后
 yum install VirtualBox-5.2-5.2.0_118431_el7-1.x86_64.rpm 
 
 
 [root@localhost ~]# docker-machine create --driver=virtualbox vbox-test
Running pre-create checks...
Error with pre-create check: "We support Virtualbox starting with version 5. Your VirtualBox install is \"WARNING: The vboxdrv kernel module is not loaded. Either there is no module\\n         available for the current kernel (3.10.0-514.el7.x86_64) or it failed to\\n         load. Please recompile the kernel module and install it by\\n\\n           sudo /sbin/vboxconfig\\n\\n         You will not be able to start VMs until this problem is fixed.\\n5.2.0r118431\". Please upgrade at https://www.virtualbox.org"



[root@localhost bash_completion.d]# ls
docker-machine.bash  docker-machine-prompt.bash  docker-machine-wrapper.bash  git  iprutils  yum-utils.bash
-bash: __docker_machine_ps1: command not found

这样解决
cd /etc/bash_completion.d/
wget https://raw.githubusercontent.com/docker/machine/v0.11.0/contrib/completion/bash/docker-machine-prompt.bash
wget https://raw.githubusercontent.com/docker/machine/v0.11.0/contrib/completion/bash/docker-machine-wrapper.bash
wget https://raw.githubusercontent.com/docker/machine/v0.11.0/contrib/completion/bash/docker-machine.bash
exit


ubuntu上的docker做swarm node


zhangcai@ubuntu:~$ sudo docker swarm init
Swarm initialized: current node (jjctxaco76d30ljh32qp0yt62) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-24gqdel80wbw7db2pz76s1are 10.10.1.169:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.

zhangcai@ubuntu:~$ zhangcai@ubuntu:~$ sudo docker swarm init
Swarm initialized: current node (jjctxaco76d30ljh32qp0yt62) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-24gqdel80wbw7db2pz76s1are 10.10.1.169:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.


为了添加manager，还需要在ubuntu上先执行
zhangcai@ubuntu:~$ docker swarm join-token manager
Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.33/swarm: dial unix /var/run/docker.sock: connect: permission denied
zhangcai@ubuntu:~$ sudo docker swarm join-token manager
To add a manager to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-4flzmhgi02bqpdolc5f9cvwnzlrra5ndyejpnn635ueycj2f8w-9n732qsnuvdjtxqheqkb01k21 10.10.1.169:2377
获得称为ubuntu swarm manager的命令，然后把这个命令在centos7上运行





和centos7上的swarm node做集群





ubuntu上

[root@localhost ~]# docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-24gqdel80wbw7db2pz76s1are 10.10.1.169:2377
Error response from daemon: This node is already part of a swarm. Use "docker swarm leave" to leave this swarm and join another one.
[root@localhost ~]# 


centos7上
[root@localhost ~]# docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-e90h6h9uowxcae0s20mdbc7y7 10.10.1.169:2377
Error response from daemon: This node is already part of a swarm. Use "docker swarm leave" to leave this swarm and join another one.
[root@localhost ~]# docker swarm leave
Error response from daemon: You are attempting to leave the swarm on a node that is participating as a manager. Removing the last manager erases all current state of the swarm. Use `--force` to ignore this message.
[root@localhost ~]# docker swarm leave --force
Node left the swarm.
[root@localhost ~]# 

[root@localhost ~]# docker swarm leave --force
Node left the swarm.
[root@localhost ~]# docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-e90h6h9uowxcae0s20mdbc7y7 10.10.1.169:2377
This node joined a swarm as a manager.
[root@localhost ~]# 


centos7上[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Creating network getstartedlab_webnet
Creating service getstartedlab_web
[root@localhost home]# docker stack ps getstartedlab
ID            NAME                  IMAGE                  NODE                   DESIRED STATE  CURRENT STATE           ERROR  PORTS
k3k1p9xvuu1e  getstartedlab_web.1   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 15 seconds ago         
zp7qil3dyh3f  getstartedlab_web.2   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 16 seconds ago         
kd0ept96bx3h  getstartedlab_web.3   caizhang/testtag:v0.1  ubuntu                 Running        Preparing 10 hours ago         
fkqofxsfxdb5  getstartedlab_web.4   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 15 seconds ago         
5c07wfogxev0  getstartedlab_web.5   caizhang/testtag:v0.1  ubuntu                 Running        Preparing 10 hours ago         
s47iilwh9y4j  getstartedlab_web.6   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 16 seconds ago         
hyw1phnpvu8h  getstartedlab_web.7   caizhang/testtag:v0.1  ubuntu                 Running        Preparing 10 hours ago         
invkkjp8yweg  getstartedlab_web.8   caizhang/testtag:v0.1  ubuntu                 Running        Preparing 10 hours ago         
ursj9e41nimq  getstartedlab_web.9   caizhang/testtag:v0.1  ubuntu                 Running        Preparing 10 hours ago         
rglf7nfxers3  getstartedlab_web.10  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 15 seconds ago         
[root@localhost home]# cat docker-compose.yml 
version: "3"
services:
  web:
    # replace username/repo:tag with your name and image details
    image: caizhang/testtag:v0.1 
    deploy:
      replicas: 10 
      resources:
        limits:
          cpus: "20"
          memory: 200M
      restart_policy:
        condition: on-failure
    ports:
      - "8081:80"
    networks:
      - webnet
networks:
  webnet:
[root@localhost home]# 
[root@localhost home]# docker stack ps getstartedlab
ID            NAME                  IMAGE                  NODE                   DESIRED STATE  CURRENT STATE           ERROR  PORTS
k3k1p9xvuu1e  getstartedlab_web.1   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 39 minutes ago         
zp7qil3dyh3f  getstartedlab_web.2   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 39 minutes ago         
kd0ept96bx3h  getstartedlab_web.3   caizhang/testtag:v0.1  ubuntu                 Running        Running 11 hours ago           
fkqofxsfxdb5  getstartedlab_web.4   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 39 minutes ago         
5c07wfogxev0  getstartedlab_web.5   caizhang/testtag:v0.1  ubuntu                 Running        Running 11 hours ago           
s47iilwh9y4j  getstartedlab_web.6   caizhang/testtag:v0.1  localhost.localdomain  Running        Running 39 minutes ago         
hyw1phnpvu8h  getstartedlab_web.7   caizhang/testtag:v0.1  ubuntu                 Running        Running 11 hours ago           
invkkjp8yweg  getstartedlab_web.8   caizhang/testtag:v0.1  ubuntu                 Running        Running 11 hours ago           
ursj9e41nimq  getstartedlab_web.9   caizhang/testtag:v0.1  ubuntu                 Running        Running 11 hours ago           
rglf7nfxers3  getstartedlab_web.10  caizhang/testtag:v0.1  localhost.localdomain  Running        Running 39 minutes ago 




ubuntu上
zhangcai@ubuntu:~$ sudo  docker stack ps getstartedlab
ID                  NAME                   IMAGE                   NODE                    DESIRED STATE       CURRENT STATE                    ERROR               PORTS
k3k1p9xvuu1e        getstartedlab_web.1    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
zp7qil3dyh3f        getstartedlab_web.2    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
kd0ept96bx3h        getstartedlab_web.3    caizhang/testtag:v0.1   ubuntu                  Running             Preparing about a minute ago                         
fkqofxsfxdb5        getstartedlab_web.4    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
5c07wfogxev0        getstartedlab_web.5    caizhang/testtag:v0.1   ubuntu                  Running             Preparing about a minute ago                         
s47iilwh9y4j        getstartedlab_web.6    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
hyw1phnpvu8h        getstartedlab_web.7    caizhang/testtag:v0.1   ubuntu                  Running             Preparing about a minute ago                         
invkkjp8yweg        getstartedlab_web.8    caizhang/testtag:v0.1   ubuntu                  Running             Preparing about a minute ago                         
ursj9e41nimq        getstartedlab_web.9    caizhang/testtag:v0.1   ubuntu                  Running             Preparing about a minute ago                         
rglf7nfxers3        getstartedlab_web.10   caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
zhangcai@ubuntu:~$ 


注意看node下的主机名ubuntu和localhost.localdomain

虽然10.10.1.115是swarm node manager，但是输入http://10.10.1.115:8081/并不会显示内容
只有输入http://10.10.1.169:8081/，也就是只有node leader那台机器的ip才会显示，


[root@localhost home]# docker service ls
ID            NAME               MODE        REPLICAS  IMAGE
co0v6ajohj91  getstartedlab_web  replicated  10/10     caizhang/testtag:v0.1
[root@localhost home]# docker node ls
ID                           HOSTNAME               STATUS  AVAILABILITY  MANAGER STATUS
jjctxaco76d30ljh32qp0yt62    ubuntu                 Ready   Active        Leader
qts74kj5ns3wv0na3efgffg8p *  localhost.localdomain  Ready   Active        Reachable



docker stack deploy -c <file> <app>  # Deploy an app; command shell must be set to talk to manager (myvm1), uses local Compose file


centos上的
[root@localhost home]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED             STATUS              PORTS               NAMES
a2911d0d64aa        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          30 minutes ago      Up 30 minutes       80/tcp              getstartedlab_web.6.s47iilwh9y4jpj8kx0au5b03l
b6b4812f6b5d        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          30 minutes ago      Up 30 minutes       80/tcp              getstartedlab_web.1.k3k1p9xvuu1essqnxou5usxyr
239457c2a427        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          30 minutes ago      Up 30 minutes       80/tcp              getstartedlab_web.4.fkqofxsfxdb5excxz5x9s257a
d2e05b1ea97c        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          30 minutes ago      Up 30 minutes       80/tcp              getstartedlab_web.2.zp7qil3dyh3f9d1y7l6j0vxnr
bd0331232002        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"  

ubuntu上的
zhangcai@ubuntu:~$ sudo docker ps
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS               NAMES
29b33e49e17a        caizhang/testtag:v0.1         "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.9.ursj9e41nimqt8sw92tce26ys
804866fc40d4        caizhang/testtag:v0.1         "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.3.kd0ept96bx3hwrhyq0lios97o
5b1e6cb4c094        caizhang/testtag:v0.1         "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.7.hyw1phnpvu8honynj7beo6j6g
70e2d5582606        caizhang/testtag:v0.1         "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.8.invkkjp8ywegsrhlri1kdnxtr
951d44cafc6c        caizhang/testtag:v0.1         "python app.py"          29 minutes ago      Up 29 minutes       80/tcp              getstartedlab_web.5.5c07wfogxev0lv33if51dw6jy
694d1c625fe2        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   6 days ago          Up 3 hours                              gitlab-runner



zhangcai@ubuntu:~$ sudo  docker stack ps getstartedlab
ID                  NAME                   IMAGE                   NODE                    DESIRED STATE       CURRENT STATE                    ERROR               PORTS
k3k1p9xvuu1e        getstartedlab_web.1    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
zp7qil3dyh3f        getstartedlab_web.2    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
kd0ept96bx3h        getstartedlab_web.3    caizhang/testtag:v0.1   ubuntu                  Running             Running 33 minutes ago                               
fkqofxsfxdb5        getstartedlab_web.4    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
5c07wfogxev0        getstartedlab_web.5    caizhang/testtag:v0.1   ubuntu                  Running             Running 33 minutes ago                               
s47iilwh9y4j        getstartedlab_web.6    caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago                       
hyw1phnpvu8h        getstartedlab_web.7    caizhang/testtag:v0.1   ubuntu                  Running             Running 33 minutes ago                               
invkkjp8yweg        getstartedlab_web.8    caizhang/testtag:v0.1   ubuntu                  Running             Running 33 minutes ago                               
ursj9e41nimq        getstartedlab_web.9    caizhang/testtag:v0.1   ubuntu                  Running             Running 33 minutes ago                               
rglf7nfxers3        getstartedlab_web.10   caizhang/testtag:v0.1   localhost.localdomain   Running             Running less than a second ago 


docker stack id centos7和ubuntu上一致，但是分别docker continer ls的image却有点不一样



[root@localhost home]# vim docker-compose.yml 
version: "3"
services:
  web:
    # replace username/repo:tag with your name and image details
    image: caizhang/testtag:v0.1
    deploy:
      replicas: 5
      resources:
        limits:
          cpus: "20"
          memory: 200M
      restart_policy:
        condition: on-failure
    ports:
      - "8081:80"
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - webnet
networks:
  webnet:

~                                                                                                                                     
~                                                                                                                                     
"docker-compose.yml" 30L, 623C written                                                                              
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Creating service getstartedlab_visualizer
Updating service getstartedlab_web (id: co0v6ajohj91l6b5nfwjpivz9)

[root@localhost home]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
co0v6ajohj91  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
dcpbfitrbzdi  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable


更改了dockerfile重启stack之后，ubuntu
zhangcai@ubuntu:~$ sudo docker stack ps getstartedlab
ID                  NAME                         IMAGE                             NODE                    DESIRED STATE       CURRENT STATE                    ERROR               PORTS
b1ijpgg06aek        getstartedlab_visualizer.1   dockersamples/visualizer:stable   ubuntu                  Running             Running 3 minutes ago                                
zp7qil3dyh3f        getstartedlab_web.2          caizhang/testtag:v0.1             localhost.localdomain   Running             Running less than a second ago                       
5c07wfogxev0        getstartedlab_web.5          caizhang/testtag:v0.1             ubuntu                  Running             Running about an hour ago                            
s47iilwh9y4j        getstartedlab_web.6          caizhang/testtag:v0.1             localhost.localdomain   Running             Running less than a second ago                       
invkkjp8yweg        getstartedlab_web.8          caizhang/testtag:v0.1             ubuntu                  Running             Running about an hour ago                            
rglf7nfxers3        getstartedlab_web.10         caizhang/testtag:v0.1             localhost.localdomain   Running             Running less than a second ago   

更改了dockerfile重启stack之后，centos

[root@localhost home]# docker stack ps getstartedlab
ID            NAME                        IMAGE                            NODE                   DESIRED STATE  CURRENT STATE              ERROR  PORTS
b1ijpgg06aek  getstartedlab_visualizer.1  dockersamples/visualizer:stable  ubuntu                 Running        Preparing 10 hours ago            
zp7qil3dyh3f  getstartedlab_web.2         caizhang/testtag:v0.1            localhost.localdomain  Running        Running about an hour ago         
5c07wfogxev0  getstartedlab_web.5         caizhang/testtag:v0.1            ubuntu                 Running        Running 11 hours ago              
s47iilwh9y4j  getstartedlab_web.6         caizhang/testtag:v0.1            localhost.localdomain  Running        Running about an hour ago         
invkkjp8yweg  getstartedlab_web.8         caizhang/testtag:v0.1            ubuntu                 Running        Running 11 hours ago              
rglf7nfxers3  getstartedlab_web.10        caizhang/testtag:v0.1            localhost.localdomain  Running        Running about an hour ago 


貌似是砍掉了之前的10个replicas里面的其中的几个








修改dockerfile之后
输入http://10.10.1.169:8080即可看到visualizer的web网页



这个中间要写紧挨着，不能有空格。/home/docker/data: /data
写成/home/docker/data:/data


[root@localhost home]# mkdir /home/docker/data
mkdir: cannot create directory ‘/home/docker/data’: No such file or directory
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
services.redis.volumes.0 must be a string
[root@localhost home]# mkdir /home/docker/data -p
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
services.redis.volumes.0 must be a string
[root@localhost home]# vim docker-compose.yml 
          cpus: "20"
          memory: 200M
      restart_policy:
        condition: on-failure
    ports:
      - "8081:80"
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - webnet
  redis:
    image: redis
    ports:
     - "6379:6379"
    volumes:
     - /home/docker/data: /data
    deploy:
      placement:
        constraints: [ node.role == manager ]
    command: redis-server --appendonly yes
    networks:
      - webnet
"docker-compose.yml" 42L, 871C                                                                                      40,7          81%
          cpus: "20"
          memory: 200M
      restart_policy:
        condition: on-failure
    ports:
      - "8081:80"
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - webnet
  redis:
    image: redis
    ports:
     - "6379:6379"
    volumes:
     - /home/docker/data:/data
    deploy:
      placement:
        constraints: [ node.role == manager ]
    command: redis-server --appendonly yes
    networks:
      - webnet
networks:
  webnet:
"docker-compose.yml" 42L, 870C written
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_web (id: co0v6ajohj91l6b5nfwjpivz9)
Updating service getstartedlab_visualizer (id: dcpbfitrbzdi2oqthhvoo5k56)
Creating service getstartedlab_redis





从visuallizer那儿可以看到redis那一块有红点，下面显示id还是undefined、preparing的状态，猜测在从远端拉取image



root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_visualizer (id: dcpbfitrbzdi2oqthhvoo5k56)
unable to pin image dockersamples/visualizer:stable to digest: Get https://registry-1.docker.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
Updating service getstartedlab_redis (id: n3d1mssqdsm5svh492ep5m60p)
Updating service getstartedlab_web (id: co0v6ajohj91l6b5nfwjpivz9)
unable to pin image caizhang/testtag:v0.1 to digest: Get https://registry-1.docker.io/v2/: net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)



redis问题

[root@localhost home]# systemctl daemon-reload
[root@localhost home]# systemctl restart docker
[root@localhost home]# systemctl status docker
● docker.service - Docker Application Container Engine
   Loaded: loaded (/usr/lib/systemd/system/docker.service; enabled; vendor preset: disabled)
   Active: active (running) since Thu 2017-10-26 02:20:34 CST; 11s ago
     Docs: https://docs.docker.com
 Main PID: 7877 (dockerd)
   Memory: 34.9M
   CGroup: /system.slice/docker.service
           ├─7877 /usr/bin/dockerd
           ├─7880 docker-containerd -l unix:///var/run/docker/libcontainerd/docker-containerd.sock --metrics-interval=0 --start-tim...
           └─8002 docker-containerd-shim 03c89f481c96bb5e436a326028d30138ab594821675777733811b020758bf318 /var/run/docker/libcontai...

Oct 26 02:20:33 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:33.984771933+08:00" level=info msg="Initializing ...1.169"
Oct 26 02:20:33 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:33.984996935+08:00" level=info msg="Daemon has co...ation"
Oct 26 02:20:33 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:33.985308242+08:00" level=info msg="Docker daemon...3.0-ce
Oct 26 02:20:34 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:34.011129155+08:00" level=info msg="Initializing ...1.169"
Oct 26 02:20:34 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:34.011466862+08:00" level=info msg="Gossip cluste...aff81"
Oct 26 02:20:34 localhost.localdomain systemd[1]: Started Docker Application Container Engine.
Oct 26 02:20:34 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:34.026416681+08:00" level=error msg="fatal task e...rn5cu9
Oct 26 02:20:34 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:34.026749187+08:00" level=info msg="API listen on....sock"
Oct 26 02:20:34 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:34.027428617+08:00" level=error msg="fatal task e...rih0xj
Oct 26 02:20:35 localhost.localdomain dockerd[7877]: time="2017-10-26T02:20:35.192640964+08:00" level=warning msg="failed to ...agent"
Hint: Some lines were ellipsized, use -l to show in full.
[root@localhost home]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
co0v6ajohj91  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
dcpbfitrbzdi  getstartedlab_visualizer  replicated  1/1       dockersamples/visualizer:stable
n3d1mssqdsm5  getstartedlab_redis       replicated  0/1       redis




之前也遇到类似的错误，这是什么原因导致的呢？

[root@localhost ~]# docker service ls
Error response from daemon: rpc error: code = 4 desc = context deadline exceeded


ubuntu上的，应该是重启后swarm不存在了


zhangcai@ubuntu:~$ sudo docker service ls
[sudo] password for zhangcai: 
Error response from daemon: rpc error: code = Unknown desc = The swarm does not have a leader. It's possible that too few managers are online. Make sure more than half of the managers are online.
zhangcai@ubuntu:~$ sudo docker node ls
Error response from daemon: rpc error: code = Unknown desc = The swarm does not have a leader. It's possible that too few managers are online. Make sure more than half of the managers are online.


ubuntu上果然只有三个worker了
zhangcai@ubuntu:~$ sudo docker container ls
CONTAINER ID        IMAGE                             COMMAND                  CREATED             STATUS              PORTS               NAMES
92feef844147        caizhang/testtag:v0.1             "python app.py"          18 minutes ago      Up 18 minutes       80/tcp              getstartedlab_web.10.6g0wqug4eqjzz4fxflwg7a4ur
3fc39a7965f5        caizhang/testtag:v0.1             "python app.py"          19 minutes ago      Up 18 minutes       80/tcp              getstartedlab_web.5.ryib79euwmkzcjo20qp0ivxrs
8391d4c3cb1e        caizhang/testtag:v0.1             "python app.py"          19 minutes ago      Up 19 minutes       80/tcp              getstartedlab_web.8.sj1ox9d9p8ocj7um8w62ci6cb
d0d5e706aee6        dockersamples/visualizer:stable   "npm start"              24 minutes ago      Up 24 minutes       8080/tcp            getstartedlab_visualizer.1.ney62zze0grmqa5xbrn37jnno
694d1c625fe2        gitlab/gitlab-runner:latest       "/usr/bin/dumb-ini..."   6 days ago          Up 5 hours                              gitlab-runner
zhangcai@ubuntu:~$ sudo docker image ls
REPOSITORY                 TAG                 IMAGE ID            CREATED             SIZE
caizhang/testtag           v0.1                8519ea07ed26        4 days ago          195MB
redis                      latest              1fb7b6c8c0d0        2 weeks ago         107MB
gitlab/gitlab-runner       latest              fa332bc1925c        2 weeks ago         371MB
hello-world                latest              05a3bd381fc2        6 weeks ago         1.84kB
dockersamples/visualizer   stable              8dbf7c60cf88        2 months ago        148MB


去浏览器上刷也只能刷到三个hostname


centos7上
[root@localhost home]# docker swarm join --token SWMTKN-1-32c8wis1j9u9l4a38s457i7vqz3bocxyhlnm8z3xqel1ar6vio-e90h6h9uowxcae0s20mdbc7y7 10.10.1.169:2377
Error response from daemon: rpc error: code = 2 desc = The swarm does not have a leader. It's possible that too few managers are online. Make sure more than half of the managers are online.

没有leader，说明ubuntu上的swarm有问题



还是只有ubuntu上面的3个container，
zhangcai@ubuntu:~$ sudo docker service ls
Error response from daemon: rpc error: code = Unknown desc = The swarm does not have a leader. It's possible that too few managers are online. Make sure more than half of the managers are online.
zhangcai@ubuntu:~$ sudo docker swarm leave
Error response from daemon: You are attempting to leave the swarm on a node that is participating as a manager. The only way to restore a swarm that has lost consensus is to reinitialize it with `--force-new-cluster`. Use `--force` to suppress this message.
zhangcai@ubuntu:~$ sudo docker container ls
CONTAINER ID        IMAGE                             COMMAND                  CREATED             STATUS              PORTS               NAMES
92feef844147        caizhang/testtag:v0.1             "python app.py"          23 minutes ago      Up 23 minutes       80/tcp              getstartedlab_web.10.6g0wqug4eqjzz4fxflwg7a4ur
3fc39a7965f5        caizhang/testtag:v0.1             "python app.py"          24 minutes ago      Up 23 minutes       80/tcp              getstartedlab_web.5.ryib79euwmkzcjo20qp0ivxrs
8391d4c3cb1e        caizhang/testtag:v0.1             "python app.py"          24 minutes ago      Up 24 minutes       80/tcp              getstartedlab_web.8.sj1ox9d9p8ocj7um8w62ci6cb
d0d5e706aee6        dockersamples/visualizer:stable   "npm start"              29 minutes ago      Up 29 minutes       8080/tcp            getstartedlab_visualizer.1.ney62zze0grmqa5xbrn37jnno
694d1c625fe2      




这个问题在重新启动两边的docker，重新做swarm后好了。

[root@localhost home]#  docker stack deploy -c docker-compose.yml getstartedlab
Creating network getstartedlab_webnet
Creating service getstartedlab_visualizer
Creating service getstartedlab_redis
Creating service getstartedlab_web
[root@localhost home]# docker stack ps 
"docker stack ps" requires exactly 1 argument(s).
See 'docker stack ps --help'.

Usage:  docker stack ps [OPTIONS] STACK

List the tasks in the stack
[root@localhost home]# docker stack ps  getstartedlab
ID            NAME                        IMAGE                            NODE                   DESIRED STATE  CURRENT STATE               ERROR  PORTS
rybjqha1iha1  getstartedlab_web.1         caizhang/testtag:v0.1            localhost.localdomain  Running        Running about a minute ago         
yewcwbmkvrz2  getstartedlab_redis.1       redis:latest                     localhost.localdomain  Running        Running about a minute ago         
yzff9im4dp2d  getstartedlab_visualizer.1  dockersamples/visualizer:stable  ubuntu                 Running        Running 10 hours ago               
6wp540fiedbm  getstartedlab_web.2         caizhang/testtag:v0.1            ubuntu                 Running        Running 10 hours ago               
so4treze7qsn  getstartedlab_web.3         caizhang/testtag:v0.1            localhost.localdomain  Running        Running about a minute ago         
lhd6oatlwylo  getstartedlab_web.4         caizhang/testtag:v0.1            ubuntu                 Running        Running 10 hours ago               
mbxyvoj02zkj  getstartedlab_web.5         caizhang/testtag:v0.1            ubuntu                 Running        Running 10 hours ago               
[root@localhost home]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
fpbsua0p84c7  getstartedlab_visualizer  replicated  1/1       dockersamples/visualizer:stable
na4hksm9fwdn  getstartedlab_redis       replicated  1/1       redis:latest
yympdq8kkjbb  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
[root@localhost home]# 


在网页版http://10.10.1.169:8080/处也能看到redis运行的相关信息 





[root@localhost data]# docker run -itd --name=networktest ubuntu
1fba8562a15d84560729e0c757d997342171225c0a65b26a7c14c6ccc110903a
[root@localhost data]# docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "b90da0e0f74b47af4c370c9906a5e1042f9daa7ea6e70b8a736ca17852a90b2a",
        "Created": "2017-10-26T02:26:20.088762725+08:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Containers": {
            "03c89f481c96bb5e436a326028d30138ab594821675777733811b020758bf318": {
                "Name": "gitlab-runner",
                "EndpointID": "6b53e191e6500b6d0fff165359ba999cfc42040642bf85d960e72d66b9175eab",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            },
            "1fba8562a15d84560729e0c757d997342171225c0a65b26a7c14c6ccc110903a": {
                "Name": "networktest",
                "EndpointID": "a7c9f393acbdcc8f47d373ead50ef413bd5da678c8b241b1efa3ffa32ac2b667",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
[root@localhost data]# 
[root@localhost data]# docker network disconnect bridge networktest
[root@localhost data]# docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "b90da0e0f74b47af4c370c9906a5e1042f9daa7ea6e70b8a736ca17852a90b2a",
        "Created": "2017-10-26T02:26:20.088762725+08:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Containers": {
            "03c89f481c96bb5e436a326028d30138ab594821675777733811b020758bf318": {
                "Name": "gitlab-runner",
                "EndpointID": "6b53e191e6500b6d0fff165359ba999cfc42040642bf85d960e72d66b9175eab",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]



[root@localhost data]# docker network ls
NETWORK ID          NAME                   DRIVER              SCOPE
b90da0e0f74b        bridge                 bridge              local
jk5qslwgqw71        bridge                 bridge              swarm
ff06e695b247        docker_gwbridge        bridge              local
ks6ej27luqng        getstartedlab_webnet   overlay             swarm
b10961a30481        host                   host                local
7m0c4pyv61n8        host                   host                swarm
iaweapeyrx3h        ingress                overlay             swarm
0da5f58ef22a        none                   null                local
[root@localhost data]# 
[root@localhost data]# docker network create -d bridge my_bridge
2c511b16f8b5a2c00f057953509c24faed80d874bcd1992794f64e68e6c89fef
[root@localhost data]# docker network ls
NETWORK ID          NAME                   DRIVER              SCOPE
jk5qslwgqw71        bridge                 bridge              swarm
b90da0e0f74b        bridge                 bridge              local
ff06e695b247        docker_gwbridge        bridge              local
ks6ej27luqng        getstartedlab_webnet   overlay             swarm
7m0c4pyv61n8        host                   host                swarm
b10961a30481        host                   host                local
iaweapeyrx3h        ingress                overlay             swarm
2c511b16f8b5        my_bridge              bridge              local
0da5f58ef22a        none                   null                local


docker run -d --net=my_bridge --name db training/postgres



[root@localhost data]# docker inspect --format='{{json .NetworkSettings.Networks}}'  db
{"my_bridge":{"IPAMConfig":null,"Links":null,"Aliases":["31fdfbd53e82"],"NetworkID":"2c511b16f8b5a2c00f057953509c24faed80d874bcd1992794f64e68e6c89fef","EndpointID":"9a903f1f1e30e019040ad464bbfcc1f5d0859bf18f3001ba8be4707e3782ae79","Gateway":"172.19.0.1","IPAddress":"172.19.0.2","IPPrefixLen":16,"IPv6Gateway":"","GlobalIPv6Address":"","GlobalIPv6PrefixLen":0,"MacAddress":"02:42:ac:13:00:02"}}
[root@localhost data]# docker image ls
REPOSITORY                    TAG                 IMAGE ID            CREATED             SIZE
caizhang/testimage            version0.1          8519ea07ed26        5 days ago          195 MB
caizhang/testtag              latest              8519ea07ed26        5 days ago          195 MB
caizhang/testtag              v0.1                8519ea07ed26        5 days ago          195 MB
friendlyhello                 latest              8519ea07ed26        5 days ago          195 MB
john/getstarted               part2               8519ea07ed26        5 days ago          195 MB
gitlab/gitlab-runner-helper   x86_64-a9a76a50     e5e66321e8ec        2 weeks ago         43.1 MB
ubuntu                        latest              747cb2d60bbe        2 weeks ago         122 MB
python                        2.7-slim            9724e90f1f17        2 weeks ago         184 MB
redis                         latest              1fb7b6c8c0d0        2 weeks ago         107 MB
gitlab/gitlab-runner          latest              fa332bc1925c        3 weeks ago         371 MB
hello-world                   latest              05a3bd381fc2        6 weeks ago         1.84 kB
golang                        1.5                 99668503de15        15 months ago       725 MB
training/postgres             latest              6fa973bb3c26        3 years ago         365 MB
[root@localhost data]# docker containers ls
docker: 'containers' is not a docker command.
See 'docker --help'
[root@localhost data]# docker container ls
CONTAINER ID        IMAGE                                                                                      COMMAND                  CREATED              STATUS              PORTS               NAMES
31fdfbd53e82        training/postgres                                                                          "su postgres -c '/..."   About a minute ago   Up About a minute   5432/tcp            db
1fba8562a15d        ubuntu                                                                                     "/bin/bash"              36 minutes ago       Up 36 minutes                           networktest
f9f6f2d9e577        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          About an hour ago    Up About an hour    80/tcp              getstartedlab_web.1.rybjqha1iha1n4h54xdduaz5x
4f0497eb18a9        caizhang/testtag@sha256:0d33bee5f70787ad05950024def472995604a4b3508f8a8974aa4d1bec463636   "python app.py"          About an hour ago    Up About an hour    80/tcp              getstartedlab_web.3.so4treze7qsn3cyct9duzhooj
fe8ead6e5fc7        redis@sha256:07e7b6cb753f8d06a894e22af30f94e04844461ab6cb002c688841873e5e5116              "docker-entrypoint..."   About an hour ago    Up About an hour    6379/tcp            getstartedlab_redis.1.yewcwbmkvrz2caspmjt3v2g5i
03c89f481c96        gitlab/gitlab-runner:latest                                                                "/usr/bin/dumb-ini..."   2 weeks ago          Up 2 hours                              gitlab-runner



[root@localhost data]# docker run -d --name web training/webapp python app.py
Unable to find image 'training/webapp:latest' locally
latest: Pulling from training/webapp
e190868d63f8: Pull complete 
909cd34c6fd7: Pull complete 
0b9bfabab7c1: Pull complete 
a3ed95caeb02: Pull complete 
10bbbc0fc0ff: Pull complete 
fca59b508e9f: Pull complete 
e7ae2541b15b: Pull complete 
9dd97ef58ce9: Pull complete 
a4c1b0cb7af7: Pull complete 
Digest: sha256:06e9c1983bd6d5db5fba376ccd63bfa529e8d02f23d5079b8f74a616308fb11d
Status: Downloaded newer image for training/webapp:latest
4661e9ef7637f169a9abfd06686b6136df3ef5629496031644a291508f086266
[root@localhost data]# docker inspect --format='{{json .NetworkSettings.Networks}}'  web
{"bridge":{"IPAMConfig":null,"Links":null,"Aliases":null,"NetworkID":"b90da0e0f74b47af4c370c9906a5e1042f9daa7ea6e70b8a736ca17852a90b2a","EndpointID":"fa5a122a72d2a865fa5fa8e2606bce8cc148a684b50416f468b57e969358ddf4","Gateway":"172.17.0.1","IPAddress":"172.17.0.3","IPPrefixLen":16,"IPv6Gateway":"","GlobalIPv6Address":"","GlobalIPv6PrefixLen":0,"MacAddress":"02:42:ac:11:00:03"}}


[root@localhost data]#  docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' web
172.17.0.3

[root@localhost data]# docker exec -it db bash
root@31fdfbd53e82:/# ping 172.17.0.2
PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.
^C
--- 172.17.0.2 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4004ms

root@31fdfbd53e82:/# ping 172.19.0.2
PING 172.19.0.2 (172.19.0.2) 56(84) bytes of data.
64 bytes from 172.19.0.2: icmp_seq=1 ttl=64 time=0.058 ms
64 bytes from 172.19.0.2: icmp_seq=2 ttl=64 time=0.111 ms
^C
--- 172.19.0.2 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 999ms
rtt min/avg/max/mdev = 0.058/0.084/0.111/0.028 ms
root@31fdfbd53e82:/# docker network ls
bash: docker: command not found
root@31fdfbd53e82:/# exit             
exit
[root@localhost data]# docker network ls
NETWORK ID          NAME                   DRIVER              SCOPE
jk5qslwgqw71        bridge                 bridge              swarm
b90da0e0f74b        bridge                 bridge              local
ff06e695b247        docker_gwbridge        bridge              local
ks6ej27luqng        getstartedlab_webnet   overlay             swarm
b10961a30481        host                   host                local
7m0c4pyv61n8        host                   host                swarm
iaweapeyrx3h        ingress                overlay             swarm
2c511b16f8b5        my_bridge              bridge              local
0da5f58ef22a        none                   null                local
[root@localhost data]# 
[root@localhost data]# docker network connect my_bridge web
[root@localhost data]# docker exec -it db bash
root@31fdfbd53e82:/# ping 172.17.0.2
PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.
^C
--- 172.17.0.2 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4003ms

root@31fdfbd53e82:/# ping web
PING web (172.19.0.3) 56(84) bytes of data.
64 bytes from web.my_bridge (172.19.0.3): icmp_seq=1 ttl=64 time=0.204 ms
64 bytes from web.my_bridge (172.19.0.3): icmp_seq=2 ttl=64 time=0.094 ms
64 bytes from web.my_bridge (172.19.0.3): icmp_seq=3 ttl=64 time=0.171 ms
^C
--- web ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 2001ms
rtt min/avg/max/mdev = 0.094/0.156/0.204/0.047 ms
root@31fdfbd53e82:/# exit
exit
[root@localhost data]#  docker inspect --format='{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' web
172.17.0.3172.19.0.3
[root@localhost data]# 


[root@localhost ~]# docker ps
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                    NAMES
6ca90fc5c512        registry:2                    "/entrypoint.sh /e..."   20 minutes ago      Up 20 minutes       0.0.0.0:5000->5000/tcp   registry
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   2 weeks ago         Up About an hour                             gitlab-runner
[root@localhost ~]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
h4cbltlp80ex  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
qaeelv5axly2  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable
y2jnra1taoe1  getstartedlab_redis       replicated  0/1       redis:latest
[root@localhost ~]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
h4cbltlp80ex  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
qaeelv5axly2  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable
y2jnra1taoe1  getstartedlab_redis       replicated  0/1       redis:latest
[root@localhost ~]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
h4cbltlp80ex  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
qaeelv5axly2  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable
y2jnra1taoe1  getstartedlab_redis       replicated  0/1       redis:latest
[root@localhost ~]# cd /home/
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_redis (id: y2jnra1taoe1vy9qfuilhbjku)
Error response from daemon: rpc error: code = 9 desc = service needs ingress network, but no ingress network is present
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_visualizer (id: qaeelv5axly2q6knh4gsfuwbk)
Error response from daemon: rpc error: code = 9 desc = service needs ingress network, but no ingress network is present
[root@localhost home]# docker ps 
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                    NAMES
6ca90fc5c512        registry:2                    "/entrypoint.sh /e..."   25 minutes ago      Up 25 minutes       0.0.0.0:5000->5000/tcp   registry
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   2 weeks ago         Up About an hour                             gitlab-runner
[root@localhost home]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
h4cbltlp80ex  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
qaeelv5axly2  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable
y2jnra1taoe1  getstartedlab_redis       replicated  0/1       redis:latest
[root@localhost home]# docker container ls
CONTAINER ID        IMAGE                         COMMAND                  CREATED             STATUS              PORTS                    NAMES
6ca90fc5c512        registry:2                    "/entrypoint.sh /e..."   25 minutes ago      Up 25 minutes       0.0.0.0:5000->5000/tcp   registry
03c89f481c96        gitlab/gitlab-runner:latest   "/usr/bin/dumb-ini..."   2 weeks ago         Up About an hour                             gitlab-runner
[root@localhost home]# docker node ls
ID                           HOSTNAME               STATUS  AVAILABILITY  MANAGER STATUS
6k4y95w670kwkivhsstvr48zb    ubuntu                 Ready   Active        Leader
t93aoudg9mt5prs4jcb6ab5d8 *  localhost.localdomain  Ready   Active        Reachable
[root@localhost home]# docker network inspect bridge
[
    {
        "Name": "bridge",
        "Id": "a6424a5981367f587ed3d01ecd37f6c8f20635cc71c25bb073fabddda37b5fe6",
        "Created": "2017-10-27T23:04:11.630677059+08:00",
        "Scope": "local",
        "Driver": "bridge",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "172.17.0.0/16",
                    "Gateway": "172.17.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Containers": {
            "03c89f481c96bb5e436a326028d30138ab594821675777733811b020758bf318": {
                "Name": "gitlab-runner",
                "EndpointID": "4531c2f5ab4ee06bc0f2bb9561934707ad01bbb3dce9e67a657f158a0de84494",
                "MacAddress": "02:42:ac:11:00:02",
                "IPv4Address": "172.17.0.2/16",
                "IPv6Address": ""
            },
            "6ca90fc5c512f319e62958785bcbe463654240a4ada70c4dbc6a37365912802b": {
                "Name": "registry",
                "EndpointID": "ae27eb4702c2fc8936e355c50e8d638876c77d206e7a56e55dc7550ec56d7ca5",
                "MacAddress": "02:42:ac:11:00:03",
                "IPv4Address": "172.17.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.bridge.default_bridge": "true",
            "com.docker.network.bridge.enable_icc": "true",
            "com.docker.network.bridge.enable_ip_masquerade": "true",
            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",
            "com.docker.network.bridge.name": "docker0",
            "com.docker.network.driver.mtu": "1500"
        },
        "Labels": {}
    }
]
[root@localhost home]# docker network inspect ingress
[
    {
        "Name": "ingress",
        "Id": "vz9hn45mznu2d0gx8po9dts3c",
        "Created": "2017-10-27T23:10:47.700500296+08:00",
        "Scope": "swarm",
        "Driver": "overlay",
        "EnableIPv6": false,
        "IPAM": {
            "Driver": "default",
            "Options": null,
            "Config": [
                {
                    "Subnet": "10.255.0.0/16",
                    "Gateway": "10.255.0.1"
                }
            ]
        },
        "Internal": false,
        "Attachable": false,
        "Containers": {
            "ingress-sbox": {
                "Name": "ingress-endpoint",
                "EndpointID": "b06c6964a49738d2da610d1a09ce20d5d90d2e76fcbd11c85734acda8219f1d1",
                "MacAddress": "02:42:0a:ff:00:03",
                "IPv4Address": "10.255.0.3/16",
                "IPv6Address": ""
            }
        },
        "Options": {
            "com.docker.network.driver.overlay.vxlanid_list": "4096"
        },
        "Labels": {},
        "Peers": [
            {
                "Name": "localhost.localdomain-87b4cb52461d",
                "IP": "10.10.1.115"
            }
        ]
    }
]
[root@localhost home]# 
[root@localhost home]# docker network ls
NETWORK ID          NAME                   DRIVER              SCOPE
t19vj98fpcw5        bridge                 bridge              swarm
a6424a598136        bridge                 bridge              local
ff06e695b247        docker_gwbridge        bridge              local
xrug34qlyplr        getstartedlab_webnet   overlay             swarm
b10961a30481        host                   host                local
x3hmjuj26r8g        host                   host                swarm
vz9hn45mznu2        ingress                overlay             swarm
2b4f1235e292        isolated_nw            bridge              local
2c511b16f8b5        my_bridge              bridge              local
0da5f58ef22a        none                   null                local
[root@localhost home]# docker stack deploy -c docker-compose.yml getstartedlab
Updating service getstartedlab_visualizer (id: qaeelv5axly2q6knh4gsfuwbk)
Error response from daemon: rpc error: code = 9 desc = service needs ingress network, but no ingress network is present
[root@localhost home]# docker service ls
ID            NAME                      MODE        REPLICAS  IMAGE
h4cbltlp80ex  getstartedlab_web         replicated  5/5       caizhang/testtag:v0.1
qaeelv5axly2  getstartedlab_visualizer  replicated  0/1       dockersamples/visualizer:stable
y2jnra1taoe1  getstartedlab_redis       replicated  0/1       redis:latest
[root@localhost home]# docker info
Containers: 43
 Running: 2
 Paused: 0
 Stopped: 41
Images: 18
Server Version: 17.03.0-ce
Storage Driver: overlay
 Backing Filesystem: xfs
 Supports d_type: true
Logging Driver: json-file
Cgroup Driver: cgroupfs
Plugins: 
 Volume: local
 Network: bridge host macvlan null overlay
Swarm: active
 NodeID: t93aoudg9mt5prs4jcb6ab5d8
 Is Manager: true
 ClusterID: myb50gztq720jbak996pu4mmz
 Managers: 2
 Nodes: 2
 Orchestration:
  Task History Retention Limit: 5
 Raft:
  Snapshot Interval: 10000
  Number of Old Snapshots to Retain: 0
  Heartbeat Tick: 1
  Election Tick: 3
 Dispatcher:
  Heartbeat Period: 5 seconds
 CA Configuration:
  Expiry Duration: 3 months
 Node Address: 10.10.1.115
 Manager Addresses:
  10.10.1.115:2377
  10.10.1.169:2377
Runtimes: runc
Default Runtime: runc
Init Binary: docker-init
containerd version: 977c511eda0925a723debdc94d09459af49d082a
runc version: a01dafd48bc1c7cc12bdb01206f9fea7dd6feb70
init version: 949e6fa
Security Options:
 seccomp
  Profile: default
Kernel Version: 3.10.0-514.el7.x86_64
Operating System: CentOS Linux 7 (Core)
OSType: linux
Architecture: x86_64
CPUs: 1
Total Memory: 976.5 MiB
Name: localhost.localdomain
ID: HTJ4:RMOU:XMIA:PDSG:DV6X:DZ6J:EISI:C7UY:ZI2G:NNHR:NN3J:3BHI
Docker Root Dir: /var/lib/docker
Debug Mode (client): false
Debug Mode (server): false
Username: caizhang
Registry: https://index.docker.io/v1/
Experimental: false
Insecure Registries:
 127.0.0.0/8
Live Restore Enabled: false


这应该是个bug，需要leave之后在创建swarm cluster才能用


